<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Avgångar från Årstaberg</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: "Segoe UI", Roboto, sans-serif;
      background-color: #000;
      color: #fff;
      overflow: hidden;
    }

    header {
      position: absolute;
      top: 0;
      left: 0;
      padding: 1vh 2vw;
      background-color: #111;
      color: #ccc;
      font-size: 2vw;
      z-index: 10;
      box-shadow: 0 0 10px #000;
    }

    .status-bar {
      position: absolute;
      top: 1vh;
      right: 2vw;
      font-size: 1.3vw;
      color: #ccc;
      text-align: right;
      line-height: 1.2;
      z-index: 10;
    }

    .container {
      display: flex;
      flex-direction: row;
      height: 100%;
      width: 100%;
      padding-top: 8vh;
      box-sizing: border-box;
    }

    .column {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 5vw;
      box-sizing: border-box;
      border-left: 2px solid #222;
    }

    .column:first-child {
      border-left: none;
    }

    .title {
      font-size: 4vw;
      color: #888;
      margin-bottom: 3vh;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .minutes {
      font-size: 14vw;
      font-weight: bold;
      color: #fff;
      margin-bottom: 1vh;
    }

    .destination {
      font-size: 5vw;
      text-align: center;
      color: #fff;
      max-width: 90%;
      line-height: 1.2;
    }

    .next-minutes {
      font-size: 5vw;
      font-weight: bold;
      color: #ccc;
      margin-bottom: 2vh;
    }

    .disruptions {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 1vh 2vw;
      background-color: #111;
      color: #f00;
      font-size: 1.6vw;
      text-align: center;
      box-shadow: 0 -2px 10px #000;
    }

    @media (orientation: portrait) {
      body::before {
        content: "Vrid mobilen till liggande läge";
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        color: #ccc;
        text-align: center;
        background-color: #111;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 0 20px #000;
      }

      .container, header, .status-bar, .disruptions {
        display: none;
      }
    }
  </style>
</head>
<body>

  <header>Årstaberg</header>

  <div class="status-bar">
    Senast: <span id="last-update">–</span><br>
    Nästa om: <span id="countdown">30</span>s
  </div>

  <div class="container">
    <div class="column">
      <div class="title">Tvärbanan</div>
      <div class="minutes" id="tvarbanan-time">–</div>
      <div class="destination" id="tvarbanan-dest">Laddar...</div>
      <div class="next-minutes" id="tvarbanan-next-time"></div>
    </div>
    <div class="column">
      <div class="title">Pendeltåg</div>
      <div class="minutes" id="pendeltag-time">–</div>
      <div class="destination" id="pendeltag-dest">Laddar...</div>
      <div class="next-minutes" id="pendeltag-next-time"></div>
    </div>
  </div>

  <div class="disruptions" id="disruptions" style="display: none;"></div>

  <script>
    const API_URL = "https://transport.integration.sl.se/v1/sites/9531/departures";
    let countdown = 30;

    function getMinutesUntil(timeStr) {
      const now = new Date();
      const departureTime = new Date(timeStr);
      const diff = Math.floor((departureTime - now) / 60000);
      return diff <= 0 ? "Nu" : `${diff} min`;
    }

    function findNextDepartures(data, groupOfLines, directionCodes) {
      return data.departures
        .filter(d =>
          d.line?.group_of_lines === groupOfLines &&
          directionCodes.includes(d.direction_code) &&
          d.stop_area?.name === "Årstaberg"
        )
        .sort((a, b) => new Date(a.expected) - new Date(b.expected))
        .slice(0, 2);
    }

    function updateDisplay(pendeltagList, tvarbananList) {
      const pTime = document.getElementById("pendeltag-time");
      const pNextTime = document.getElementById("pendeltag-next-time");
      const pDest = document.getElementById("pendeltag-dest");

      const tTime = document.getElementById("tvarbanan-time");
      const tNextTime = document.getElementById("tvarbanan-next-time");
      const tDest = document.getElementById("tvarbanan-dest");

      const [p1, p2] = pendeltagList;
      const [t1, t2] = tvarbananList;

      if (p1) {
        pTime.textContent = getMinutesUntil(p1.expected);
        pDest.textContent = p1.destination;
        pNextTime.textContent = p2 ? `Sedan: ${getMinutesUntil(p2.expected)}` : "";
      } else {
        pTime.textContent = "–";
        pDest.textContent = "Ingen avgång";
        pNextTime.textContent = "";
      }

      if (t1) {
        tTime.textContent = getMinutesUntil(t1.expected);
        tDest.textContent = t1.destination;
        tNextTime.textContent = t2 ? `Sedan: ${getMinutesUntil(t2.expected)}` : "";
      } else {
        tTime.textContent = "–";
        tDest.textContent = "Ingen avgång";
        tNextTime.textContent = "";
      }
    }

    function updateStatusBar() {
      document.getElementById("countdown").textContent = countdown;
    }

    function updateLastUpdateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString("sv-SE", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
      document.getElementById("last-update").textContent = timeStr;
    }

    function updateDisruptions(data) {
      const div = document.getElementById("disruptions");
      const disruptions = data?.disruptions;
      if (disruptions && disruptions.length > 0) {
        const msg = disruptions.map(d => d.message).join(" | ");
        div.style.display = "block";
        div.textContent = msg;
      } else {
        div.style.display = "none";
        div.textContent = "";
      }
    }

    function fetchDepartures() {
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          const pendeltag = findNextDepartures(data, "Pendeltåg", [0, 2]);
          const tvarbanan = findNextDepartures(data, "Tvärbanan", [1]);
          updateDisplay(pendeltag, tvarbanan);
          updateLastUpdateTime();
          updateDisruptions(data);
        })
        .catch(err => {
          console.error("Fel vid hämtning:", err);
          document.getElementById("pendeltag-dest").textContent = "Fel";
          document.getElementById("tvarbanan-dest").textContent = "Fel";
        });
    }

    fetchDepartures();

    setInterval(() => {
      countdown--;
      updateStatusBar();
      if (countdown <= 0) {
        countdown = 30;
        fetchDepartures();
      }
    }, 1000);
  </script>
</body>
</html>
