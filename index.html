<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Avgångstavla</title>
<style>
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: sans-serif;
    width: 640px;
    height: 360px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
  }
  .columns {
    display: flex;
    flex: 1;
    gap: 12px;
  }
  .col {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #111;
    border-radius: 8px;
    padding: 10px;
    overflow: hidden;
  }
  .top-row {
    display: flex;
    align-items: center;
    font-size: 30px;
    margin-bottom: 4px;
    min-width: 0;
  }
  .line {
    font-weight: bold;
    padding: 0.4rem;
    border-radius: 0.5rem;
    display: inline-block;
    text-align: center;
    width: 4ch;
    min-width: 4ch;
    margin-right: 10px;
    flex-shrink: 0;
  }
  .destination {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .big-minutes {
    font-family: 'Orbitron', sans-serif;
    font-size: 64px;
    font-weight: 700;
    text-align: center;
    margin: 10px 0 30px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 16px;
    table-layout: fixed;
  }
  th {
    text-align: left;
    color: #bbb;
    font-weight: normal;
    padding-bottom: 4px;
    border-bottom: 2px solid #444;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  td {
    padding: 2px 0;
    vertical-align: middle;
    border-bottom: 1px solid #333;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
td:nth-child(1), th:nth-child(1) {
  width: 6ch; /* tillräckligt för två siffror + padding */
}
td:nth-child(2), th:nth-child(2) {
  width: auto; /* flexar ut */
}
td:nth-child(3), th:nth-child(3) {
  width: 6ch; /* tillräckligt för t.ex. '12 min' */
  text-align: right;
}
  .next-line {
    font-weight: bold;
    padding: 0.3rem;
    border-radius: 0.5rem;
    display: inline-block;
    text-align: center;
    width: 4ch;
    min-width: 4ch;
    font-size: 0.9em;
  }
  .next-dest {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .next-time {
    text-align: right;
    white-space: nowrap;
  }
</style>
</head>
<body>
<div class="columns">
  <div class="col">
    <div class="top-row">
      <div id="tram-line" class="line">-</div>
      <div id="tram-dest" class="destination"></div>
    </div>
    <div id="tram-min" class="big-minutes">--</div>
    <table>
      <thead>
        <tr>
          <th>Linje</th>
          <th>Destination</th>
          <th>Tid</th>
        </tr>
      </thead>
      <tbody id="tram-next">
        <tr><td colspan="3" style="text-align:center;color:#bbb;">Laddar...</td></tr>
      </tbody>
    </table>
  </div>
  <div class="col">
    <div class="top-row">
      <div id="train-line" class="line">-</div>
      <div id="train-dest" class="destination"></div>
    </div>
    <div id="train-min" class="big-minutes">--</div>
    <table>
      <thead>
        <tr>
          <th>Linje</th>
          <th>Destination</th>
          <th>Tid</th>
        </tr>
      </thead>
      <tbody id="train-next">
        <tr><td colspan="3" style="text-align:center;color:#bbb;">Laddar...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
let currentSiteId = 9531;

function getLineColors(designation) {
  let backgroundColor = "#555";
  let textColor = "white";
  if (["17", "18", "19"].includes(designation)) backgroundColor = "#169d4c";
  else if (["1", "2", "3", "4"].includes(designation)) backgroundColor = "#008aca";
  else if (["57", "74", "154", "164"].includes(designation)) backgroundColor = "#d61d23";
  else if (["40", "41", "42", "43", "44"].includes(designation)) backgroundColor = "#d05d9a";
  else if (["30", "31"].includes(designation)) backgroundColor = "#b65f1f";
  return { backgroundColor, textColor };
}

async function fetchDepartures() {
  try {
    const res = await fetch(`https://transport.integration.sl.se/v1/sites/${currentSiteId}/departures`);
    if (!res.ok) throw new Error(`API-svar: ${res.status} ${res.statusText}`);
    const data = await res.json();
    if (!data.departures) throw new Error("Ingen 'departures'-nyckel i API-svaret");

    const trams = data.departures
      .filter(dep => dep.line.transport_mode === "TRAM" && dep.direction_code === 1)
      .slice(0, 3);

    const trains = data.departures
      .filter(dep => dep.line.transport_mode === "TRAIN" && dep.direction_code === 2)
      .slice(0, 3);

    updateColumn("tram", trams);
    updateColumn("train", trains);
  } catch (err) {
    console.error("Fel vid hämtning:", err);
    showErrorState("tram");
    showErrorState("train");
  }
}

function updateColumn(prefix, departures) {
  const lineEl = document.getElementById(`${prefix}-line`);
  const destEl = document.getElementById(`${prefix}-dest`);
  const minEl = document.getElementById(`${prefix}-min`);
  const tbody = document.getElementById(`${prefix}-next`);

  if (!departures.length) {
    showErrorState(prefix);
    return;
  }

  const first = departures[0];
  const designation = first.line.designation || first.line.name || "-";
  const colors = getLineColors(designation);

  lineEl.textContent = designation;
  lineEl.style.backgroundColor = colors.backgroundColor;
  lineEl.style.color = colors.textColor;

  destEl.textContent = first.destination;
  minEl.textContent = first.display;

  tbody.innerHTML = "";
  departures.slice(1).forEach(dep => {
    const depDesignation = dep.line.designation || dep.line.name || "-";
    const depColors = getLineColors(depDesignation);

    const row = document.createElement("tr");
    row.innerHTML = `
      <td><span class="next-line" style="background-color:${depColors.backgroundColor};color:${depColors.textColor};">${depDesignation}</span></td>
      <td class="next-dest">${dep.destination}</td>
      <td class="next-time">${dep.display}</td>
    `;
    tbody.appendChild(row);
  });
}

function showErrorState(prefix) {
  document.getElementById(`${prefix}-line`).textContent = "-";
  document.getElementById(`${prefix}-line`).style.backgroundColor = "#555";
  document.getElementById(`${prefix}-dest`).textContent = "";
  document.getElementById(`${prefix}-min`).textContent = "--";
  document.getElementById(`${prefix}-next`).innerHTML =
    `<tr><td colspan="3" style="text-align:center;color:#bbb;">Ingen data tillgänglig</td></tr>`;
}

fetchDepartures();
setInterval(fetchDepartures, 30000);
</script>
</body>
</html>
